!function(e,n){"function"==typeof define&&define.amd?define([],n):"undefined"!=typeof module&&module.exports?module.exports=n():e.ReconnectingEventSource=n()}(this,function(){function e(n,t,o){function c(e,n){var t=document.createEvent("CustomEvent");return t.initCustomEvent(e,!1,!1,n),t}var r={debug:!1,automaticOpen:!0,reconnectInterval:5e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:1e4};o||(o={});for(var i in r)"undefined"!=typeof o[i]?this[i]=o[i]:this[i]=r[i];this.url=n,this.reconnectAttempts=0,this.readyState=EventSource.CONNECTING,this.protocol=null;var d,u=this,a=!1,s=!1,l=document.createElement("div");l.addEventListener("open",function(e){u.onopen(e)}),l.addEventListener("close",function(e){u.onclose(e)}),l.addEventListener("connecting",function(e){u.onconnecting(e)}),l.addEventListener("message",function(e){u.onmessage(e)}),l.addEventListener("error",function(e){u.onerror(e)}),this.addEventListener=l.addEventListener.bind(l),this.removeEventListener=l.removeEventListener.bind(l),this.dispatchEvent=l.dispatchEvent.bind(l),this.open=function(n){d=new EventSource(u.url,t||[]),n||l.dispatchEvent(c("connecting")),(u.debug||e.debugAll)&&console.debug("ReconnectingEventSource","attempt-connect",u.url),d.onopen=function(t){(u.debug||e.debugAll)&&console.debug("ReconnectingEventSource","onopen",u.url),u.protocol=d.protocol,u.readyState=EventSource.OPEN,u.reconnectAttempts=0;var o=c("open");o.isReconnect=n,n=!1,l.dispatchEvent(o)},d.onmessage=function(n){(u.debug||e.debugAll)&&console.debug("ReconnectingEventSource","onmessage",u.url,n.data);var t=c("message");t.data=n.data,t.lastEventId=n.lastEventId,l.dispatchEvent(t)},d.onerror=function(t){if(u.debug&&(document.getElementById("id_title").innerHTML="["+Date()+"] ONERROR "+String(t.target.readyState)+"<br/>"+document.getElementById("id_title").innerHTML),0==t.target.readyState){var o=c("error");o.readyState=EventSource.CONNECTING,l.dispatchEvent(o)}else if(clearTimeout(i),d.close(),d=null,a)u.readyState=EventSource.CLOSED,l.dispatchEvent(c("close"));else{u.debug&&(document.getElementById("id_title").innerHTML="["+Date()+"] onerror not forcedClose<br/>"+document.getElementById("id_title").innerHTML),u.readyState=EventSource.CONNECTING;var o=c("error");o.readyState=EventSource.CONNECTING,l.dispatchEvent(o),n||s||((u.debug||e.debugAll)&&console.debug("ReconnectingEventSource","onerror",t),l.dispatchEvent(o));var r=u.reconnectInterval*Math.pow(u.reconnectDecay,u.reconnectAttempts),i=setTimeout(function(){u.debug&&(document.getElementById("id_title").innerHTML="["+Date()+"] OPENING "+(r>u.maxReconnectInterval?u.maxReconnectInterval:r)+"<br/>"+document.getElementById("id_title").innerHTML),u.reconnectAttempts++,u.open(!0)},r>u.maxReconnectInterval?u.maxReconnectInterval:r)}}},1==this.automaticOpen&&this.open(!1),this.send=function(n){if(d)return(u.debug||e.debugAll)&&console.debug("ReconnectingEventSource","send",u.url,n),d.send(n);throw"INVALID_STATE_ERR : Pausing to reconnect EventSource"},this.close=function(e,n){"undefined"==typeof e&&(e=1e3),a=!0,d&&d.close(e,n)},this.refresh=function(){d&&d.close()}}return e.prototype.onopen=function(e){},e.prototype.onclose=function(e){},e.prototype.onconnecting=function(e){},e.prototype.onmessage=function(e){},e.prototype.onerror=function(e){},e.debugAll=!1,e.CONNECTING=EventSource.CONNECTING,e.OPEN=EventSource.OPEN,e.CLOSED=EventSource.CLOSED,e});